name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude:
    # ë³´ì•ˆ: íŠ¹ì • ì‚¬ìš©ìë§Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í—ˆìš© + @claude ë©˜ì…˜ ì¡°ê±´
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
        (github.event_name == 'pull_request' && github.event.action == 'opened')
      ) &&
      (
        github.repository_owner == github.actor ||
        github.actor == 'jaehoonE7877'
      )
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
      checks: read
      statuses: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # PRì˜ ê²½ìš° ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ fetch-depth ì¦ê°€
          fetch-depth: 0
          # PRì˜ head refë¥¼ ì²´í¬ì•„ì›ƒ
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Git for PR analysis
        if: github.event_name == 'pull_request' || github.event.pull_request
        run: |
          # PR ì •ë³´ ì„¤ì •
          echo "PR_NUMBER=${{ github.event.pull_request.number || github.event.issue.number }}" >> $GITHUB_ENV
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          
          # Git ì„¤ì •
          git config --global user.name "Claude Code Review"
          git config --global user.email "claude-code@anthropic.com"
          
          # Base ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ìƒì„±
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > changed_files.txt || true
          echo "Changed files:"
          cat changed_files.txt || echo "No changed files detected"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # ì„±ëŠ¥ ìµœì í™”
          max_turns: 5
          timeout_minutes: 15
          
          # ëª¨ë¸ ì„¤ì •
          model: "claude-sonnet-4-20250514"
          
          # í—ˆìš©ëœ ë„êµ¬ë“¤ (iOS ê°œë°œìš©)
          allowed_tools: |
            Bash(find),
            Bash(cat),
            Bash(head),
            Bash(tail),
            Bash(grep),
            Bash(git log),
            Bash(git show),
            Bash(git diff),
            Bash(git status),
            Bash(xcodebuild -list),
            Bash(swift --version),
            Bash(tuist --version),
            Bash(swiftlint version),
            Bash(swiftformat --version)
          
          # í”„ë¡œì íŠ¸ë³„ ì»¤ìŠ¤í…€ ì§€ì¹¨
          custom_instructions: |
            # iOS Swift í”„ë¡œì íŠ¸ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´
            
            ë‹¹ì‹ ì€ iOS Swift ê°œë°œ ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ê¸°ì¤€ì— ë”°ë¼ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤:
            
            ## ğŸ¯ ë¦¬ë·° ëª©í‘œ
            - **ì™„ì „í•œ ì½”ë“œ ë¦¬ë·° ì œê³µ**: ë‹¨ìˆœí•œ ì§„í–‰ìƒí™©ì´ ì•„ë‹Œ êµ¬ì²´ì ì¸ í”¼ë“œë°±
            - **ì‹¤í–‰ ê°€ëŠ¥í•œ ê°œì„ ì‚¬í•­ ì œì‹œ**: ì½”ë“œ ì˜ˆì œì™€ í•¨ê»˜ ëª…í™•í•œ ê°€ì´ë“œë¼ì¸
            - **ì•„í‚¤í…ì²˜ ë° ë””ìì¸ íŒ¨í„´ ê²€ì¦**: Clean Swift (VIP) ì•„í‚¤í…ì²˜ ì¤€ìˆ˜
            
            ## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            ### 1. ì½”ë“œ í’ˆì§ˆ
            - [ ] Swift 6.0+ ìµœì‹  ê¸°ëŠ¥ í™œìš© ì—¬ë¶€
            - [ ] iOS 18+ API ì ì ˆí•œ ì‚¬ìš©
            - [ ] SOLID ì›ì¹™ ì¤€ìˆ˜
            - [ ] ì—ëŸ¬ í•¸ë“¤ë§ ë° ë°©ì–´ì  í”„ë¡œê·¸ë˜ë°
            - [ ] ë©”ëª¨ë¦¬ ê´€ë¦¬ (ê°•í•œ ì°¸ì¡° ìˆœí™˜ ë°©ì§€)
            
            ### 2. ì•„í‚¤í…ì²˜
            - [ ] Clean Swift (VIP) íŒ¨í„´ ì¤€ìˆ˜
            - [ ] ì±…ì„ ë¶„ë¦¬ (SRP) ì ìš©
            - [ ] ì˜ì¡´ì„± ì£¼ì… íŒ¨í„´ ì‚¬ìš©
            - [ ] Protocol ê¸°ë°˜ ì„¤ê³„
            
            ### 3. SwiftUI
            - [ ] SwiftUI ë„¤ì´í‹°ë¸Œ íŒ¨í„´ ì‚¬ìš©
            - [ ] ì„±ëŠ¥ ìµœì í™” (ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€)
            - [ ] ì ‘ê·¼ì„± (VoiceOver) ì§€ì›
            - [ ] ìƒíƒœ ê´€ë¦¬ (@State, @StateObject, @ObservableObject)
            
            ### 4. ë³´ì•ˆ
            - [ ] í•˜ë“œì½”ë”©ëœ API Key, ë¯¼ê°ì •ë³´ í™•ì¸
            - [ ] ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
            - [ ] ë„¤íŠ¸ì›Œí¬ í†µì‹  ë³´ì•ˆ (HTTPS, Certificate Pinning)
            
            ### 5. í…ŒìŠ¤íŠ¸
            - [ ] Swift Testing í”„ë ˆì„ì›Œí¬ ì‚¬ìš© (@Suite, @Test)
            - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
            
            ### 6. ì½”ë“œ ìŠ¤íƒ€ì¼
            - [ ] SwiftFormat ì¼ê´€ì„±
            - [ ] ë„¤ì´ë° ì»¨ë²¤ì…˜ (camelCase, PascalCase)
            - [ ] ë¬¸ì„œí™” ì£¼ì„ (/// ë°©ì‹)
            
            ## ğŸ“ ë¦¬ë·° í˜•ì‹
            
            ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì„¸ìš”:
            
            ```markdown
            # ğŸ” Code Review Summary
            
            ## âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„
            - êµ¬ì²´ì ì¸ ì½”ë“œ ìœ„ì¹˜ì™€ í•¨ê»˜ ì¹­ì°¬í•  ì ë“¤
            
            ## âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„
            
            ### ğŸ”§ Critical Issues (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
            - **íŒŒì¼ëª…:ë¼ì¸ë²ˆí˜¸**: ë¬¸ì œì  ì„¤ëª…
            - **ìˆ˜ì • ë°©ì•ˆ**: ì½”ë“œ ì˜ˆì œì™€ í•¨ê»˜
            
            ### ğŸ’¡ Suggestions (ê¶Œì¥ì‚¬í•­)
            - **ì„±ëŠ¥ ìµœì í™”**
            - **ì½”ë“œ ê°€ë…ì„±**
            - **ì•„í‚¤í…ì²˜ ê°œì„ **
            
            ## ğŸ§ª í…ŒìŠ¤íŠ¸ ê¶Œì¥ì‚¬í•­
            - ì¶”ê°€í•´ì•¼ í•  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë“¤
            
            ## ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ
            - ê´€ë ¨ Apple ë¬¸ì„œ ë§í¬
            - Swift Evolution ì œì•ˆì„œ ë“±
            ```
            
            ## ğŸš€ ì‹¤í–‰ ì§€ì¹¨
            
            1. **ì „ì²´ PR ë¶„ì„**: ëª¨ë“  ë³€ê²½ëœ íŒŒì¼ì„ ì²´í¬
            2. **ìƒì„¸í•œ í”¼ë“œë°±**: ì¼ë°˜ì ì¸ ì¡°ì–¸ì´ ì•„ë‹Œ êµ¬ì²´ì ì¸ ê°œì„ ì 
            3. **ì½”ë“œ ì˜ˆì œ ì œê³µ**: ë¬¸ì œì ê³¼ í•´ê²°ë°©ì•ˆì„ ì½”ë“œë¡œ ë³´ì—¬ì£¼ê¸°
            4. **ìš°ì„ ìˆœìœ„ êµ¬ë¶„**: Critical/Important/Nice-to-have êµ¬ë¶„
            5. **ê±´ì„¤ì ì¸ í†¤**: ë¹„íŒì ì´ì§€ ì•Šê³  ë„ì›€ì´ ë˜ëŠ” ë°©í–¥ìœ¼ë¡œ

      - name: Get PR Details
        if: github.event_name == 'pull_request' || github.event.pull_request
        id: pr_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number || context.payload.pull_request.number
            });
            
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body);
            core.setOutput('pr_author', pr.user.login);

      - name: Comment on completion
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ steps.claude.outcome }}' === 'success' ? 'âœ… ì™„ë£Œ' : 'âŒ ì‹¤íŒ¨';
            const executionTime = '${{ steps.claude.outputs.execution_time }}' || 'ì •ë³´ ì—†ìŒ';
            
            let body = `<!-- claude-code-review-status -->
            ## ğŸ¤– Claude Code Review ${status}
            
            **ì‹¤í–‰ ì‹œê°„**: ${executionTime}
            **ëª¨ë¸**: Claude Sonnet 4
            **ë¦¬ë·° ëŒ€ìƒ**: iOS Swift í”„ë¡œì íŠ¸
            
            `;
            
            if ('${{ steps.claude.outcome }}' === 'failure') {
              body += `
            âš ï¸ **ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤**
            - ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”
            - @claudeë¥¼ ë‹¤ì‹œ ë©˜ì…˜í•˜ì—¬ ì¬ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            `;
            } else {
              body += `
            âœ¨ **ì½”ë“œ ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**
            - ìœ„ì˜ í”¼ë“œë°±ì„ í™•ì¸í•´ì£¼ì„¸ìš”
            - ì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ @claudeë¥¼ ë©˜ì…˜í•´ì£¼ì„¸ìš”
            `;
            }
            
            const issueNumber = context.issue?.number || context.payload.pull_request?.number;
            
            if (issueNumber) {
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
